<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Wasm Fractal Explorer</title>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        background-color: #222;
        color: #eee;
      }
      canvas {
        border: 2px solid #555;
        margin-top: 20px;
      }
      #status {
        font-size: 1.2em;
        height: 2em;
      }
    </style>
  </head>
  <body>
    <h1>Mandelbrot Set Explorer (C/Wasm)</h1>
    <p>
      The image below is generated by high-performance C code running in your
      browser via WebAssembly.
    </p>
    <div id="status">Loading WebAssembly module...</div>
    <canvas id="canvas" width="800" height="800"></canvas>

    <script>
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const statusElement = document.getElementById("status");
      const width = canvas.width;
      const height = canvas.height;

      function generateAndDrawFractal(Module) {
        statusElement.textContent =
          "WebAssembly module loaded. Generating fractal...";
        const start = performance.now();

        const generateMandelbrot = Module._generate_mandelbrot;
        const malloc = Module._malloc;
        const free = Module._free;

        const bufferPtr = malloc(width * height * 4);

        generateMandelbrot(bufferPtr, width, height, 255);

        const imageDataArray = new Uint8ClampedArray(
          Module.HEAPU8.subarray(bufferPtr, bufferPtr + width * height * 4)
        );

        const imageData = new ImageData(imageDataArray, width, height);
        ctx.putImageData(imageData, 0, 0);

        free(bufferPtr);

        const end = performance.now();
        statusElement.textContent = `Fractal generated in C/Wasm in ${(
          end - start
        ).toFixed(2)} ms.`;
      }

      // Define the Module object with onRuntimeInitialized
      const Module = {
        onRuntimeInitialized: function () {
          generateAndDrawFractal(this);
        },
      };

      // Load the Emscripten output
      const script = document.createElement("script");
      script.src = "mandelbrot.js";
      document.body.appendChild(script);
    </script>
  </body>
</html>
